Investigating Unusual Login Attempts and Unauthorized Access

## Objective
Today I am going to investigate unusual login attempts and unauthorized access to a machine. This lab has been provided by CyberDefenders. Please see last page for my Incident Report. 

Scenario: As a cybersecurity analyst at SecureTech Industries, you've been alerted to unusual login attempts and unauthorized access within the company's network. Initial indicators suggest a potential brute-force attack on user accounts. Your mission is to analyze the provided log data to trace the attack's progression, determine the scope of the breach, and attacker's TTPs.

### Tactics

-Execution
-Persistence
-Privilege Escalation
-Credential Access
-Lateral Movement


### Tools Used

-Splunk
-VirusTotal
-Whois

## Steps

First tool we are provided with is Splunk. I need to find out what the attackerâ€™s IP address is. We know a brute force attach was used, so I will filter for failed login attempts which is win log event ID 4625. I also enter IP in the search so it can highlight the IP addresses in the raw data. 

![image](https://github.com/user-attachments/assets/7d2cd1b4-890f-41ea-b95d-e1deb622c900)

I add an additional field winlog.event_data.Ipaddress  I see 16 events were generated by IP 77.91.78.115.

![image](https://github.com/user-attachments/assets/1b06fa54-edb4-4454-a532-64442cc9aa54)

I look up this IP address on VisrusTotal and Whois. It has been flagged as malicious by multiple vendors.
![image](https://github.com/user-attachments/assets/062b8019-1a1d-48c8-8cda-4fae97ef2d62)
![image](https://github.com/user-attachments/assets/63b21e41-3172-40e3-8ca6-6554d15480f5)

Going down the events from the initial failed logon attempt, we can see multiple failed login attempts using multiple credentials. The threat actor even tried to login using the administrator account.

![image](https://github.com/user-attachments/assets/5ab27b1a-b9a7-448f-846c-796c2e7e8730)

Here we can see multiple successful logins by the threat actor. Looks like account mwilliams had unauthorized access. 

![image](https://github.com/user-attachments/assets/751e88d9-ca09-423c-8866-aef237846e66)

I now need to find out what malicious file the attacker used to gain access. We know the threat actor managed to login to the system. We can check if the client ran a malicious file using powershell. We get 223 events from this search.

![image](https://github.com/user-attachments/assets/9637a3cc-11ae-427b-b6c7-6cd9f34c8f01)

Since we are looking for a file being executed, I look under winlog.event_data.TargetFilename

![image](https://github.com/user-attachments/assets/6f921d5d-2c1a-4922-880b-e85c3aa6b858)

One thing that sticks out is OfficeUpdater.exe that is in the temp folder. Odd.
There are two events related to this file. I switch to raw data and save the hash values.

![image](https://github.com/user-attachments/assets/eb3874a8-218d-4ab8-977d-cbd24cc8f1c6)


Looking more in the field winlog.event_data.TargetFilename we can see the threat actor created a zip file to store his tools. Most likely for lateral movement and privilege escalation. 

![image](https://github.com/user-attachments/assets/7b22bf2e-00aa-42d8-ab11-dbbbecf9c666)

Next I need to find the process ID of the tool responsible for dumping credentials. A well known tool is mimikatz. I do a simple search for it and we find it in the folder we had previously discovered. 

![image](https://github.com/user-attachments/assets/5d6e0fc8-3803-461a-8a16-59c57b8dd634)

The process ID for mimikatz is 3708

![image](https://github.com/user-attachments/assets/4679c49d-1fba-4a9d-a16e-cf720987c6e1)

As is the often the case in these attacks. The attacker will compromise another account for lateral movement. I need to find out which user was also compromised. I search the attackers IP and event code 4624 (Successful Login) Looks like jsmith was also compromised by this attacker. 

index=goldenspray 77.91.78.115 "event.code"=4624

![image](https://github.com/user-attachments/assets/6b7e5ba7-6f55-4d9f-b31e-c7d345ddaa67)

Next I need to find the scheduled task created by the attacker for persistence on the domain controler.
I search index=goldenspray Powershell "winlog.provider_name"="Microsoft-Windows-TaskScheduler" We can see the answer is FilesCheck

![image](https://github.com/user-attachments/assets/5ad7547b-0358-410e-96f2-09a63fe649fc)

Next task is to find the encryption type used in the environment Kerberos tickets. 

I add the field winlog.event_data.TicketEncryptionType  We can see here the encryption type is 0x17. We need to go to the Microsoft site to see what 0x17 is called.

![image](https://github.com/user-attachments/assets/52c0f83a-f92e-4518-ab82-3158e2edd22c)

Here we can see the answer is RC4-HMAC

![image](https://github.com/user-attachments/assets/cd201da1-8cce-460c-a912-c311b518e5b7)

In the final task I need to provide the full path of the output file in preparation for data exfiltration.

As previously discovered, we know the threat actor also compromised user jsmith. I search Powershell.exe and jsmith. Under winlog.event_data.TargetFilename we get the answer: C:\Users\Public\Documents\Archive_8673812.zip

![image](https://github.com/user-attachments/assets/6082f2d1-10b3-4d45-a2dc-764aa8db2df6)

![image](https://github.com/user-attachments/assets/197bffec-2ec4-4afe-98d9-2364034a1aef)

